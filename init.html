<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" >
	 <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
	  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src=
  "https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js">
	  </script>
</head>
<style type="text/css">
	.ui-datepicker-trigger{
		width: 25px;
	}
	td, th{
		padding: 4px;
    	border: 1px solid #bdbdbd;
	}
	.loading {
    	color: red;
	}
	.show{
		visibility: visible !important;
		height: 1000px !important;
	}
</style>
<body>
<script type="text/javascript">
	function loadcat(t){
		console.log('changed',this,t);

	}
	$(document).ready(()=>{
		load();
		$("#startDate" ).datepicker({

	      showOn: "button",
	      buttonImage: "images/cal.jpg",
	      buttonImageOnly: true,
	      buttonText: "Select date",
	      dateFormat: 'yy-mm-dd',
		onSelect: function(d,i) {
 			console.log('loaded',d,i);
 			localStorage.setItem('startDate',d);
    	}
    	});
		$("#endDate" ).datepicker({
	      showOn: "button",
	      buttonImage: "images/cal.jpg",
	      buttonImageOnly: true,
	      buttonText: "Select date",
	      dateFormat: 'yy-mm-dd',
		onSelect: function(d,i) {
 			console.log('loaded',d,i);
 			localStorage.setItem('endDate',d);
    	}
    	});

    })
	function dateConverter(dateString){
		var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
		var d = new Date(dateString);
		var dayName = days[d.getDay()];
		return (dayName)+'('+new Date(dateString).toLocaleString("en-US",{  month: "short",  day: "numeric",hour:'numeric',minute:'numeric'})+')';
	}
	function dateDay(dateString){
		var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
		var d = new Date(dateString);
		var dayName = days[d.getDay()];
		return dayName;
	}
    function filter(weekly){
    		if(localStorage.getItem('startDate') && localStorage.getItem('endDate')){
    			loadtable(localStorage.getItem('category'),weekly);
    		}else{
    			alert("Selct startDate and endDate");
    		}
    	}
    function clear(){
		localStorage.removeItem('startDate');
		localStorage.removeItem('endDate');
    }
    function clearFilter(){
    	clear();
    	loadtable(localStorage.getItem('category'));
    }
</script>

<div id="demo"></div>
</div>
<script>
	var userId=localStorage.getItem('userId');
   async function load(){
	 let total=await loadAPI("/expense_app/apifile.php?totalCountUser="+userId);
	let totalList=JSON.parse(total);
	document.querySelector(".totalTable").innerHTML+="<tr>";
		let sumval=0.0;
	totalList.forEach(element => {
		sumval=sumval+parseFloat(element?.total);
		document.querySelector(".totalTable").innerHTML+=`
			<td>${element?.category} -</td>
			<td>${element?.total}</td>
		`;
	});
	document.querySelector(".totalTable").innerHTML+="</tr>";
	document.querySelector(".totalTable").innerHTML+=`<tr>
		<td><b>Total</b></td>
		<td><b>${sumval}</b></td>
	</tr>`;

    let categoryList= await loadAPI("/expense_app/apifile.php?userId="+userId);
    let list=JSON.parse(categoryList);
	console.log(JSON.parse(categoryList),'sdf');
	list.forEach(element => {
		document.querySelector("#browsers").innerHTML+=`<option value="${element?.category}">`;
	});
	clear()
	loadtable(list?.[0]?.category);
   }

   async function loadtable(val,weekFlag){
	console.log(val);
	document.querySelector(".loading").innerHTML="Loading...!";
	localStorage.setItem('category',val);
	document.querySelector(".tbody").innerHTML="";
	let url="/expense_app/apifile.php?userId="+userId+"&category="+val;
	let startDate=localStorage.getItem('startDate');
	let endDate=localStorage.getItem('endDate');
	if(endDate){
		url="/expense_app/apifile.php?userId="+userId+"&category="+val+"&startDate="+startDate+"&endDate="+endDate;
	}
    let tableList= await loadAPI(url);
	document.querySelector(".loading").innerHTML="";
	console.log(document.querySelector(".tbody"));
	let list=JSON.parse(tableList);
	let tmplist=JSON.parse(JSON.stringify(list));
	tmplist=tmplist.sort((a,b)=>new Date(a?.time).getTime()-new Date(b?.time).getTime());
	let chartLabel=tmplist.map(ele=>ele?.material);
	let chartData=tmplist.map(ele=>ele?.price);
	chartplot(chartLabel,chartData);
	document.querySelector(".tbody").innerHTML+="<tr>";
	let sumval=0.0;
	if(weekFlag){
		list=mergeList(list);
	}
	console.log(list,'list')
	list.forEach(element => {
		sumval=sumval+parseFloat(element?.price);
		// document.querySelector(".tbody").innerHTML+=`
		
		// 	<td>${element?.material}</td>
		// 	<td>${element?.unit}</td>
		// 	<td style="width:100px"><small>${dateConverter(element?.time)}</small></td>
		// 	<td>${element?.price}</td>
		// 	<td><b><a href="./edit.php?id=${element?.id}">Edit</a></b></td>
		// 	<td><a href="./delete.php?id=${element?.id}" onclick="return confirm('Are you sure? to delete')">D</a></td>
		// `;
		document.querySelector(".tbody").innerHTML+=`
		<td style="width:100px"><small>${dateConverter(element?.time)}</small></td>
		<td>${element?.material}</td>
		<td>${element?.unit}</td>
		<td>${element?.price}</td>
		<td><b><a href="./edit.php?id=${element?.id}">Edit</a></b></td>
		<td><a href="./delete.php?id=${element?.id}" onclick="return confirm('Are you sure? to delete')">D</a></td>
	`;
	});
	document.querySelector(".tbody").innerHTML+="</tr>";
	document.querySelector(".tbody").innerHTML+=`<tr>
		<td><b>Total</b></td>
		<td></td>
		<td></td>
		<td><b>${sumval}</b></td>
	</tr>`;
	// console.log(tableList);
   }
function mergeList(obj){
	obj=obj.map(ee=>{ee['day']=dateDay(ee['time']);return ee;});
	newObj=[];
	obj.forEach(e=>{
		let obj={};
		if(newObj.some(ee=>ee?.day==e?.day)){
			let tmp=newObj.find(ee=>ee?.day==e?.day);
			tmp['price']=parseFloat(tmp['price'])+parseFloat(e['price']);
			tmp['unit']=(tmp['unit'])+' + '+(e['unit']);
			tmp['material']=(tmp['material'])+' + '+(e['material']);
		}else{
			newObj.push(e);
		}
	});
	return (newObj)	
}
function loadAPI(url) {
    return new Promise((res,rej)=>{
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", url,true);
        xhttp.onreadystatechange = function() {//Call a function when the state changes.
            if(xhttp.readyState == 4 && xhttp.status == 200) {
                res(xhttp.responseText);
            }
        }
        xhttp.send();
    })

}
function thisweek(){
	// console.log(new Date(moment().endOf('week').valueOf()))
	let tmp=new Date(new Date(moment().endOf('week').valueOf())).toLocaleString("arn-CL",{  year:'numeric',month: "numeric",  day: "numeric"});
	console.log(tmp);
	localStorage.setItem('startDate',dateformatreverse(moment().startOf('week').add('d',1).valueOf()));
	localStorage.setItem('endDate',dateformatreverse(moment().endOf('week').add('d',1).valueOf()));
	filter(true);
}

function lastweek(){
	localStorage.setItem('startDate',dateformatreverse(moment().startOf('week').add('d',1).subtract(7,'days').valueOf()));
	localStorage.setItem('endDate',dateformatreverse(moment().endOf('week').add('d',1).subtract(7,'days').valueOf()));

	filter(true);
}
function thismonth(){
	localStorage.setItem('startDate',dateformatreverse(moment().startOf('month').valueOf()));
	localStorage.setItem('endDate',dateformatreverse(moment().endOf('month').valueOf()));

	filter();
}
function chartshow(){
	document.getElementById('container').classList.toggle("show");
	// load();
}
function dateformatreverse(dat){
	// console.log(dat);
	let tmp=new Date(dat);
	// console.log(tmp.getMonth(),tmp.getDate());
	// let dat=new Date(new Date(moment().startOf('week').subtract(7,'days').valueOf())).toLocaleString("arn-CL",{  year:'numeric',month: "numeric",  day: "numeric"});
	// let date=dat.split('/');
	console.log(tmp,'tmp');
	return tmp.getFullYear()+'-'+((tmp.getMonth()>=9?(tmp.getMonth()+1):('0'+(tmp.getMonth()+1))))+'-'+tmp.getDate();
}
</script>
<script type="text/javascript" src="echart.js"></script>

<?php
?>
<div class="container">
	<h5><a href="./upload_app">Upload Slips</a></h5>
	<h4><a href="./addcat.html">Add Category</a></h4>
	<input list="browsers" name="browser" id="browser" onchange="loadtable(value)">
	<datalist id="browsers">
	</datalist>
	<h2><a href="./add.php">Add Expenses</a></h2>
	<table>
		<head>
			<tr>
				<th>Category </th>
				<th>Expense </th>
			</tr>
		</head>
		<tbody class="totalTable">
			
		</tbody>
	</table>
	<br>
	<p><input type="text" id="startDate" placeholder="Start Date"> <input type="text" id="endDate" placeholder="End Date"> <button onclick="filter()">Filter</button><button onclick="clearFilter()"> X</button></p>
	<p><button  onclick="thisweek()">This Week</button>
		 <button  onclick="lastweek()">last Week</button> 
		 <button  onclick="thismonth()">This Month</button>
		 <button  onclick="chartshow()">chart show</button>
		</p>

	<div class="loading"></div>
	<table>
		<head>
			<tr>
				<th>Time</th>
				<th>Matrial/Labour</th>
				<th>Unit</th>
				<th>Price</th>
				<th>Action</th>
			</tr>
			<!-- <tr>
				<th>Time</th>
				<th>Labour</th>
				<th>Targar</th>
				<th>Mestri</th>
				<th>Bar Bending</th>
				<th>Other</th>
				<th>Unit</th>
				<th>Price</th>
				<th>Action</th>
			</tr> -->
		</head>
		<!-- <tbody>
			<?php foreach($tmp1 as $key=>$value){ ?>
				<tr>
					<td><?php echo ($value['material']); ?></td>
					<td><?php echo ($value['unit']); ?></td>
					<td><?php echo ($value['time']); ?></td>
					<td><b><?php echo ($value['price']); ?></b></td>
					<td><b><a href="./edit.php?id=<?php echo ($value['id']); ?>">Edit</a></b></td>
					<td><a href="./delete.php?id=<?php echo ($value['id']); ?>" onclick="return confirm('Are you sure? to delete')">D</a></td>
				</tr>
			<?php } ?>
		</tbody> -->
		<tbody class="tbody">
		</tbody>
		<!-- <tbody>
			<tr>
				<td></td>
			</tr>
		</tbody> -->
	</table>
</div>
<script type="text/javascript">
	$(document).ready(()=>{
		let label=['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
		let data=[120, 200, 150, 80, 70, 110, 130];
		// chartplot(label,data);
	});
  function chartplot(label,data){
	var dom = document.getElementById('container');
    var myChart = echarts.init(dom, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var app = {};
    
    var option;

    option = {
		dataset: {
    source: form(label,data)
  },
  grid: { containLabel: true },
  xAxis: { name: 'amount' },
  yAxis: { type: 'category' },
  tooltip: {
    trigger: 'item'
  },
  visualMap: {
    orient: 'horizontal',
    left: 'center',
    min: 10,
    max: 100,
    text: ['High Score', 'Low Score'],
    // Map the score column to color
    dimension: 0,
    inRange: {
      color: ['#65B581', '#FFCE34', '#FD665F']
    }
  },
  series: [
    {
      type: 'bar',
      encode: {
        // Map the "amount" column to X axis.
        x: 'amount',
        // Map the "product" column to Y axis
        y: 'product'
      }
    }
  ]
	};

    if (option && typeof option === 'object') {
      myChart.setOption(option);
    }

    window.addEventListener('resize', myChart.resize);
  }
  function form(label,data){
			let list=[];
			let large=largest(data);
			console.log(large);
			list.push(['score', 'amount', 'product']);

			label.forEach((ele,i)=>{
				console.log(ele,i);
				list.push([((data[i]/large)*100).toFixed(),data[i],ele])
			});
			return(list);
		}
		function largest(arr){
			var largest = parseFloat(arr[0]);
			for (var i = 0; i < arr.length; i++) {
			  if (parseFloat(arr[i]) > largest ) {
			    largest = parseFloat(arr[i]);
			  }
			}
			return largest;
		}
  </script>
  	<div id="container" style="height: 1000px;"></div>
</body>
</html>